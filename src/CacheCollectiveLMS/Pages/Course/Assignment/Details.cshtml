@page
@model RazorPagesMovie.Pages.Course.Assignment.DetailsModel

@{
    ViewData["Title"] = $"Details - {Model.Assignment.Title}";
    var IsInstructor = HttpContext.Session.GetString("IsInstructor");
}

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
        var data = google.visualization.arrayToDataTable([
            ['Grade Category', 'Number of Students', { role: 'style' }],
            ['A (90-100)', @Model.AGrades, 'color: #4CAF50'],
            ['B (80-89)', @Model.BGrades, 'color: #2196F3'],
            ['C (70-79)', @Model.CGrades, 'color: #FFC107'],
            ['D (60-69)', @Model.DGrades, 'color: #FF9800'],
            ['F (<60)', @Model.FGrades, 'color: #F44336']
        ]);

        var options = {
            title: 'Grade Distribution',
            legend: { position: 'none' },
            hAxis: { title: 'Grade Category' },
            vAxis: { title: 'Number of Students' },
            bar: { groupWidth: '50%' }
        };
        var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
        chart.draw(data, options);
    }
</script>

<!-- Main Heading -->
<h1 class="mb-4">Assignment Details</h1>

<!-- Assignment Information Section -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h4 class="card-title">Assignment: @Model.Assignment.Title</h4>
        <p class="card-text">
            @if (IsInstructor == "False" && Model.CurrentSubmission is Models.Submission && Model.CurrentSubmission.GradedPoints.HasValue)
            {
                double? gradePercentage = (@Model.CurrentSubmission.GradedPoints / @Model.Assignment.MaxPoints) * 100;
                gradePercentage = Math.Truncate(gradePercentage ?? 0 * 100);
                <strong>Grade: @gradePercentage%</strong>
            }
        </p>
        <hr />
        <dl class="row">
            <dt class="col-sm-3">Title:</dt>
            <dd class="col-sm-9">@Model.Assignment.Title</dd>

            <dt class="col-sm-3">Description:</dt>
            <dd class="col-sm-9">@Model.Assignment.Description</dd>

            <dt class="col-sm-3">Max Points:</dt>
            <dd class="col-sm-9">
                @if (Model.Submissions.Any(s => s.GradedPoints.HasValue))
                {
                    foreach (var submission in Model.Submissions)
                    {
                        if (submission.GradedPoints.HasValue)
                        {
                            @submission.GradedPoints @: / @Model.Assignment.MaxPoints
                            <br />
                        }
                    }
                }
                else
                {
                    @Model.Assignment.MaxPoints
                }
            </dd>

            <dt class="col-sm-3">Due Date:</dt>
            <dd class="col-sm-9">@Model.Assignment.DueDate.ToString("MM/dd/yyyy")</dd>

            <dt class="col-sm-3">Submission Type:</dt>
            <dd class="col-sm-9">@Model.Assignment.SubmissionType</dd>

            @if (IsInstructor == "False" && Model.Assignment.SubmissionType == Models.SubmissionType.FileUpload)
            {
                <dt class="col-sm-3">Download Submission:</dt>
                <dd class="col-sm-9"> <a class="btn btn-link d-inline" href="@Url.Content($"~/{Model.CurrentSubmission.FilePath}")">@Model.CurrentSubmission.FileName</a> </dd>
            }
        </dl>

        <!-- Submit Button (Compact) -->
        @if (IsInstructor == "False")
        {
            <div class="mt-3">
                <a class="btn btn-primary btn-sm" asp-page="./Submit" asp-route-AssignmentId="@Model.Assignment.Id" asp-route-CourseId="@Model.Assignment.CourseId">Submit</a>
            </div>
        }
    </div>
</div>

<!-- Grade Distribution Chart Section (For Students) -->
@if (IsInstructor == "False")
{
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h3>Class Grade Distribution</h3>
            <div id="chart_div" style="width: 100%; height: 500px;"></div>
        </div>
    </div>
}

<!-- Actions Section -->
<div class="mt-4">
    <a class="btn btn-secondary" asp-page="Index" asp-route-courseId="@Model.Assignment.CourseId">Back to List</a>

    @if (IsInstructor == "True")
    {
        <a class="btn btn-outline-primary ml-2" asp-page="Edit" asp-route-id="@Model.Assignment.Id" asp-route-courseId="@Model.Assignment.CourseId">Edit Assignment</a>
        <a class="btn btn-outline-primary ml-2" asp-page="Submissions/Submissions" asp-route-AssignmentId="@Model.Assignment.Id" class="btn btn-sm btn-outline-info">Submissions</a>
    }
</div>
