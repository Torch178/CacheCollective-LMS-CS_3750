@using Microsoft.AspNetCore.Http;
@using System.Security.Claims;
@using RazorPagesMovie.Services;
@using RazorPagesMovie.Models;
@inject IHttpContextAccessor HttpContextAccessor;
@inject NotificationService NotificationService;

@{
    var userIdStr = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    int userId;
    int.TryParse(userIdStr, out userId);

    List<Notification> notifications = await NotificationService.GetNotificationsAsync(userId);
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/RazorPagesMovie.styles.css" asp-append-version="true" />
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3">
            <div class="container">
                <!-- Logo on the left side -->
                <a class="navbar-brand" href="/Users/Index">
                    <img src="path_to_logo.png" alt="Cache Collective" height="40"> <!-- Add your logo here -->
                </a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                    <!-- Links on the right side -->
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <!-- Home Link -->
                        <li class="nav-item">
                            <a class="nav-link text-dark" href="/Users/Index">Home</a>
                        </li>
                        @{
                            var IsInstructor = HttpContextAccessor.HttpContext.Session.GetString("IsInstructor");
                        }
                        @if (IsInstructor == "True")
                        {
                            <!-- Courses Link -->
                            <li class="nav-item">
                                <a class="nav-link text-dark" href="/Course/Index">Courses</a>
                            </li>
                        }
                        else if (IsInstructor == "False")
                        {
                            <!-- Registration Link -->
                            <li class="nav-item">
                                <a class="nav-link text-dark" href="/Users/Registration">Registration</a>
                            </li>
                            <!-- Account Link -->
                            <li class="nav-item">
                                <a class="nav-link text-dark" href="/Users/Account">Account</a>
                            </li>
                        }
                        @if (User.Identity.IsAuthenticated) // Make sure that the user is logged in
                        {
                            <!-- Calendar Link -->
                            <li class="nav-item">
                                <a class="nav-link text-dark" href="/Calendar">Calendar</a>
                            </li>
                        }
                    </ul>

                    <!-- Profile/Login Section (Right Corner) -->
                    <ul class="navbar-nav ms-auto">
                        @if (User.Identity.IsAuthenticated)
                        {
                            <!-- Notification Bell Button with Dropdown -->
                            <div class="dropdown">
                                <button class="btn bg-transparent position-relative" id="notificationBell" data-bs-toggle="dropdown" aria-expanded="false">
                                    
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bell" viewBox="0 0 16 16">
                                        <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2M8 1.918l-.797.161A4 4 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4 4 0 0 0-3.203-3.92zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5 5 0 0 1 13 6c0 .88.32 4.2 1.22 6" />
                                    </svg>
                                    @if (notifications.Count > 0)
                                    {
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                            @notifications.Count
                                            <span class="visually-hidden">unseen notifications</span>
                                        </span>
                                    }
                                </button>

                                <ul class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="notificationBell" style="width: 300px; max-height: 400px; overflow-y: auto;">
                                    <li class="dropdown-header">Notifications</li>
                                    <!-- Notifications -->
                                    @foreach (Notification notification in notifications)
                                    {
                                        var course = await NotificationService.GetCourseByIdAsync(notification.CourseId);
                                        var assignment = await NotificationService.GetAssignmentByIdAsync(notification.AssignmentId);

                                        <li class="dropdown-item">
                                            <form method="post" asp-page="/Index" asp-page-handler="MarkAsRead" asp-route-notificationId="@notification.Id">
                                                <button type="submit" class="btn btn-link p-0 text-start" style="text-decoration: none">
                                                    <p>@(course?.Title ?? "?") - @(assignment?.Title ?? "?") - @notification.Description</p>
                                                </button>
                                            </form>
                                        </li>
                                    }
                                </ul>
                            </div>

                            <!-- Dropdown for logged-in users -->
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle text-dark" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Profile
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                                    <li><a class="dropdown-item" href="/Users/Profile">View Profile</a></li>
                                    <li><a class="dropdown-item" href="/Users/Logout">Logout</a></li>
                                </ul>
                            </li>
                        }
                        else
                        {
                            <!-- Login link if user is not logged in -->
                            <li class="nav-item">
                                <a class="nav-link text-dark" href="/Users/Login">Login</a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="border-top footer text-muted position-relative">
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <script src="~/js/site.js" asp-append-version="true"></script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>